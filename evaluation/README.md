# Evaluate Certified Traffic Analysis Models


### Train Base Traffic Analysis Models

```
python evaluation/train.py --dataset DATASET_NAME --model MODEL_NAME --augment CERTIFICATION_METHOD_NAME 
```

* Choose `DATASET_NAME` from CICDOH20 and TIISSRC23. 

* Choose `MODEL_NAME` from six traffic analysis models kFP, Kitsune, Whisper, DF, YaTC and TrafficFormer.

* When passing a `CERTIFICATION_METHOD_NAME` to `--augment`, the base traffic analysis model will be trained using the smoothing samples generated by the corresponding certification method. When `augment` is set to `None`, the base traffic analysis model will be trained using the original flow samples in the dataset.

* `CERTIFICATION_METHOD_NAME` can be chose from CertTA, VRS and BARS. RS-Del is a special case of CertTA where only smoothing parameter `pr_sel` is used,  while smoothing parameters `beta_length, beta_time_ms` are set to `None`. The detailed explanation and default settings of the smoothing parameters can be found in `/CertTA_public/evaluation/opts.py` and `/CertTA_public/evaluation/config/`, respectively.

* The trained model and training logs will be saved in the `/CertTA_public/model/MODEL_NAME/save/DATASET_NAME/` directory.

### Evaluate Base/Certified Traffic Analysis Models on Clean Datasets

```
python evaluation/test.py --dataset DATASET_NAME --model MODEL_NAME --augment CERTIFICATION_METHOD_NAME --smoothed CERTIFICATION_METHOD_NAME
```

* When passing a `CERTIFICATION_METHOD_NAME` to `--augment` and  `--smoothed`, we apply the randomized smoothing methodology to build a certified traffic anlaysis model for evaluation. When `augment` and  `smoothed` are set to `None`, we directly evaluate the base traffic analysis model.

* For each flow, a dictionary instance will be saved to record the information required for accuracy meassurement and robustness region derivation, such as the original flow label, the predicted class and the corresponding probability, etc. These classification results of test flows will be saved as json files in the `/CertTA_public/model/MODEL_NAME/save/DATASET_NAME/` directory. 

```
python evaluation/collect_classification_results.py --dataset DATASET_NAME --model MODEL_NAME --augment CERTIFICATION_METHOD_NAME --smoothed CERTIFICATION_METHOD_NAME
```

* By running `collect_classification_results.py`, the classification results saved by `test.py` will be collected to calculate the accuracy/precision/recall/f1-score of each traffic class and their macro aggregation. These metrics will be saved as a `empirical_acc.txt` file in the same directory of the classification results.

```
python evaluation/plot_certifiedacc_cdf.py --dataset DATASET_NAME --model MODEL_NAME --augment CERTIFICATION_METHOD_NAME --smoothed CERTIFICATION_METHOD_NAME
```

* By running `plot_certifiedacc_cdf.py`, the classification results saved by `test.py` will be collected to plot the certified accuracy curves under different attack intensities. The plotted figure will be saved as a `certifiedacc_cdf.pdf` file in the same directory of the classification results.

* Note: we only support plotting the CDF curve of certified accuracy for CertTA. When running `plot_certifiedacc_cdf.py`, the CERTIFICATION_METHOD_NAME must be set to CertTA.

### Evaluate Base/Certified Traffic Analysis Models on Adversarial Datasets

Follow the instructions in [/CertTA_public/attacks/](https://github.com/InspiringGroup-Lab/CertTA/tree/main/attack) to generate adversarial perturbations based on Blanket, Amoeba and Prism. Then,


```
python evaluation/test.py --dataset DATASET_NAME --model MODEL_NAME --augment CERTIFICATION_METHOD_NAME --smoothed CERTIFICATION_METHOD_NAME --attack ATTACK_NAME
```

* Set CERTIFICATION_METHOD_NAME to choose base/certified traffic analysis models as aforementioned.

* Choose ATTACK_NAME from Blanket, Amoeba and Prism. Specify the attack intensities by setting attack-related paramters (e.g., `attack_r_additive_star` and `attack_insert_pkts`) in `/CertTA_public/evaluation/opts.py`. 

* The classification results of adversarial flows will be saved as json files in the `/CertTA_public/model/MODEL_NAME/save/DATASET_NAME/` directory. 

```
python evaluation/collect_classification_results.py --dataset DATASET_NAME --model MODEL_NAME --augment CERTIFICATION_METHOD_NAME --smoothed CERTIFICATION_METHOD_NAME --attack ATTACK_NAME
```

* The classification results of adversarial flows will be collected to calculate the accuracy/precision/recall/f1-score of each traffic class and their macro aggregation. These metrics will be saved as a `empirical_acc.txt` file.

* Based on the classification results of the clean flows without adversarial perturbations, the robustness region will be derived to meassure the certified accuracy against adversarial flows. The certified accuracy of each traffic class and their macro aggregation will be saved as a `certified_acc.txt` file.